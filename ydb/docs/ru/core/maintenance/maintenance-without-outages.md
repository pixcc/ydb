# Обслуживание кластера без потери доступности

В промышленных инсталляциях кластер {{ ydb-short-name }} состоит из серверов с дисками. На сервере запускается один [статический узел](../cluster/topology.md), работающий с дисками, и несколько [динамических узлов](../cluster/topology.md).

Периодически кластер {{ ydb-short-name }} необходимо обслуживать, например, обновлять его версию или заменять сломавшиеся диски. Работы по обслуживанию могут привести к недоступности кластера или имеющихся баз данных из-за:
- Превышения модели отказа затронутых [групп хранения](../concepts/_includes/databases/storage_groups.md#storage-groups).
- Превышения модели отказа [State Storage](../deploy/configuration/config.md#domains-state).
- Недостатка вычислительных ресурсов в следствии остановки слишком большого количества динамических узлов.

Чтобы избежать этого, в {{ ydb-short-name }} есть встроенный компонент, который следит за состоянием кластера — *Cluster Management System (CMS)*. CMS реализован в виде системной таблетки, доступной через gRPC API. В CMS можно согласовать проведение работ. Для этого необходимо создать [задачу обслуживания](#maintenance-task) и попросить в ней CMS взять эксклюзивные блокировки на компоненты кластера (например, узлы или сервера), которые будут задействованы в обслуживании. Компоненты, на которых взяты блокировки считаются недоступными с точки зрения CMS, и их можно безопасно обслуживать. CMS проверит текущее состояние кластера и возьмет блокировки, только если работы не приведут к потери доступности.

{% note warning "Поломки во время проведения согласованных работ" %}

Во время проведения работ, согласованных CMS, в кластере могут произойти поломки, из-за которых доступность кластера окажется под угрозой. Рекомендуется в срочном порядке завершить работы по обслуживанию, если это поможет снизить риск потери доступности.

{% endnote %}

## Задача обслуживания {#maintenance-task}

*Задача обслуживания* — представляет собой набор действий, которые пользователь просит выполнить CMS для возможности проведения безопасного обслуживания. Например, одним из действий является взятие эксклюзивной блокировки на компонент кластера — узел или сервер. 

В задаче действия делятся на группы. Действия из одной группы выполняются атомарно. На данный момент группы могут состоять только из одного действия.

Если в данный момент действие выполнить нельзя, CMS сообщает причину и время, когда стоит обновить задачу, и переводит действие в статус *ожидания*. При обновлении задачи CMS повторно пытается выполнить действия в статусе ожидания.

У *выполненных* действий есть дедлайн, после которого они считаются *завершенными* и прекращают иметь эффект на кластер. Например, снимается эксклюзивная блокировка. Пользователь может досрочно завершить действие.

{% note info "Затянувшиеся работы" %}

Если работы по обслуживанию кластера продолжают проводиться после завершения действий, то это расценивается как поломка в кластере.

{% endnote %}

Задачи по обслуживанию не удаляются автоматически.

### Режим доступности {#availability-mode}

В задаче обслуживания можно указать режим доступности кластера, который должен соблюдаться при [проверке выполнимости действий](#check-actionability-algorithm). Поддерживаются следующие режимы:
- **Strong** — режим доступности, минимизирующий возможность поломки кластера.
    - Допускается не более одного недоступного [VDisk]((../concepts/cluster/_includes/distributed_storage/distributed_storage_interface.md#storage-groups)) в каждой из затрагиваемых групп хранения.
    - Допускается не более одного недоступного кольца State Storage.
- **Weak** — режим доступности, не позволяющий превысить модель отказа.
    - Допускается не более двух недоступных VDisk-ов для затрагиваемых групп хранения со схемой [block-4-2](../administration/production-storage-config.md#reliability).
    - Допускается не более четырех недоступных VDisk-ов, три из которых должны находиться в одном датацентре, для затрагиваемых групп хранения со схемой [mirror-3-dc](../administration/production-storage-config.md#reliability). 
    - Допускается не более `(nto_select - 1) / 2` недоступных колец State Storage.
- **Force** — принудительный режим доступности, модель отказа игнорируется.

По умолчанию используется **Strong**.

### Приоритет {#priority}

У задачи обслуживания можно указать приоритет. Меньшее значение означает больший приоритет. Когда CMS рассматривает задачу, то состояние кластера рассматривается в худшем случае, как будто все действия в статусе ожидания из задач с большим приоритетом выполнены. Таким обраом действия задачи не могут быть выполнены, пока все конфликтующие действия из задач с большим приоритетом не будут завершены. Задачи с одинаковым приоритетом не имеют преимущества друг перед другом.

## Кластерные и тенантные пределы недоступных узлов {#cluster-and-tenant-limits}

В конфигурации CMS можно настроить предел количества недоступных узлов для базы данных (тенанта) или для кластера в целом. Поддерживаются относительные и абсолютные пределы.

## Алгоритм проверки выполнимости действий {#check-actionability-algorithm}

CMS последовательно идет по каждой группе действий и проверяет действие внутри группы:
- Если объектом действия является сервер, то CMS проверяет можно ли выполнить действие со всеми узлами, запущенными на сервере. 
- Если объектом действий является узел, то CMS проверяет:
    - Есть ли блокировка на данном узле.
    - Можно ли взять блокировку на данный узел в соотвествии с тенантными и кластерными пределами недоступных узлов.
    - Можно ли взять блокировки на все VDisk-и данного узла. Для этого проверяется:
        - Есть ли блокировка на узле, которой принадлежит данный VDisk.
        - Можно ли взять блокировку на данный VDisk в соотвествии с режимом доступности.
    - Можно ли взять блокировку на кольцо State Storage данного узла в соотвествии с режимом доступности.
    - Можно ли взять блокировку на данный узел в соотвествии с пределом недоступных узлов, на которых могут запускаться системные таблетки определенного типа.
    
Если проверки прошли успешно, то на проверенные узлы берется временная блокировка и CMS рассматривает следующую группу действий. Временные блокировки позволяют понять, конфликтуют ли запрошенные в разных группах действия между собой. После полного завершения проверки все временные блокировки снимаются.
