# Обслуживание кластера без потери доступности

В промышленных эксплуатациях кластер {{ ydb-short-name }} состоит из серверов с дисками. На сервере запускается один [статический узел](../cluster/topology.md), работающий с дисками, и несколько [динамических узлов](../cluster/topology.md).

Периодически кластер {{ ydb-short-name }} необходимо обслуживать, например, обновлять его версию или заменять сломавшиеся диски. Работы по обслуживанию могут привести к недоступности кластера или имеющихся баз данных из-за:
- Превышения модели отказа затронутых [групп хранения](../concepts/_includes/databases/storage_groups.md#storage-groups).
- Превышения модели отказа [State Storage](../deploy/configuration/config.md#domains-state).
- Остановки слишком большого количества динамических узлов одной из баз данных.
- Остановки слишком большого количества узлов в кластере в целом.

Чтобы избежать этого, в {{ ydb-short-name }} есть встроенный компонент, который следит за состоянием кластера.
Он называется *Cluster Management System (CMS)*. CMS реализован в виде системной [таблетки](../concepts/cluster/_includes/common_scheme_ydb/tablets.md#tablets), доступной через gRPC API и CLI. В CMS можно послать запрос с просьбой выдать *разрешение* на определенные работы. CMS проверит текущее состояние кластера и выдаст разрешение, если работы не приведут к потери доступности.

{% note warning "Поломки во время проведения разрешенных работ" %}

Во время проведения работ, разрешенных CMS, в кластере могут произойти поломки, из-за которых доступность кластера станет под угрозой. Рекомендуется в срочном порядке завершить работы по обслуживанию, если это поможет снизить риск потери доступности.

{% endnote %}

## Запрос в CMS {#request}

*Запрос* в CMS — это просьба выдать разрешение для конкретного пользователя на определенные действия с кластером на указанное время. Действиями могут быть, например, перезапуск узлов на сервере или выключение сервера целиком.

Объектами действий могут быть:
- Высокоуровневые — [тенанты](./embedded_monitoring/ydb_monitoring.md#tenant_list_page), отдельные сервисы на сервере (например, все динамические узлы), сервера целиком.
- Низкоуровневые — [VDisk-и](../concepts/cluster/_includes/distributed_storage/distributed_storage_interface.md#storage-groups), [PDisk-и](../concepts/cluster/_includes/distributed_storage/distributed_storage_interface.md#storage-groups) и узлы кластера.

{% note info "Затянувшиеся работы" %}

Если работы по обслуживанию кластера продолжают проводиться после истечения времени, на которое выдавалось разрешение, то это расценивается как поломка в кластере.

{% endnote %}

В запросе может быть несколько действий с кластером, CMS выдает разрешение на каждое действие по отдельности. По умолчанию CMS отвечает отказом на весь запрос, если хотя бы на одно действие из запроса нельзя выдать разрешение, но поддерживается и частичная выдача разрешений.

Если CMS временно не может выдать разрешения на действия в запросе, то CMS сообщает время, когда стоит повторить запрос.

### Режим доступности {#availability-mode}

В запросе можно указать режим доступности кластера, который должен соблюдаться при выдаче разрешений. Поддерживаются следующие режимы:
- *Max availability* — режим доступности, минимизирующий возможность поломки кластера.
    - Допускается не более одного недоступного VDisk в каждой из затрагиваемых групп хранения.
    - Допускается не более одного недоступного кольца State Storage.
- *Keep available* — режим доступности, не позволяющий превысить модель отказа.
    - Допускается не более двух недоступных VDisk-ов для затрагиваемых групп хранения со схемой [block-4-2](../administration/production-storage-config.md#reliability).
    - Допускается не более четырех недоступных VDisk-ов, три из которых должны находиться в одном датацентре, для затрагиваемых групп хранения со схемой [mirror-3-dc](../administration/production-storage-config.md#reliability). 
    - Допускатеся не более `(nto_select - 1) / 2` недоступных колец State Storage.
- *Force restart* — принудительный режим доступности, модель отказа игнорируется.

По умолчанию используется *Max availability*.

### Запланированные запросы {#scheduled-requests}

Если CMS временно не может выдать разрешения на действия в запросе, то можно попросить CMS "запланировать" такой запрос. *Запланированные* запросы сохраняются в CMS и им выдается идентификатор. Позже с помощью идентификатора можно еще раз попробовать попросить CMS выдать разрешения на действия в запланированном запросе или удалить его.

### Развоз VDisk-ов {#vdisk-eviction}

Можно попросить CMS перед выдачей разрешений увезти VDisk-и со всех узлов, затронутых в запросе. Такой запрос автоматически становится запланированным. Разрешения на действия в запросе не будут выданы, пока все VDisk-и не уедут на другие узлы.

### Приоритеты запросов {#request-priorities}

В запросе можно указать его приоритет. Меньшее значение означает больший приоритет. Выдача разрешений для запроса будет заблокирована конфликтующим запланированным запросом с большим приоритетом.

### Кластерные и тенантные пределы недоступных узлов {#cluster-and-tenant-limits}

В конфигурации CMS можно настроить предел количества недоступных узлов для базы данных (тенанта) или для кластера в целом. Поддерживаются относительные и абсолютные пределы.

## Разрешение в CMS {#permission}

В CMS *разрешение* выдается на определенное действие с кластером в ответ на запрос пользователя. Выдача разрешения означает взятие эксклюзивных блокировок на низкоуровневые объекты кластера (узлы, VDisk-и, PDisk-и), затрагиваемые действием. Объекты кластера, на которых взята эксклюзивная блокировка, считаются недоступными с точки зрения CMS.

Разрешение выдается на определенное время. После истечения времени, CMS автоматически удаляет разрешение и таким образом снимает все связанные блокировки. При досрочном завершении работ по обслуживанию можно самостоятельно удалить разрешение.

## Алгоритм выдачи разрешения {#permission-algorithm}

Когда в CMS приходит запрос на выдачу разрешений на действия с кластером, CMS рассматривает состояние кластера, как будто всем запланированным запросам с более высоким приоритетом, чем у текущего запроса, уже были выданы все разрешения и соотвествующие блокировки. 

Первым делом CMS проверяет уехали ли все VDisk-и со всех узлов, затрагиваемых в запросе, если это требовалось. После чего CMS последовательно идет по переданным в запросе действиям и проверяет, можно ли выдать разрешение на требуемое действие. 
- Если объектом действия является тенант, то CMS транслирует действие в набор действий с серверами, на которых запущены динамические узлы тенанта. 
- Если объектом действия является сервер, то CMS проверяет можно ли выполнить действие со всеми узлами, запущенными на сервере. 
- Если объектом действия является отдельный сервис на сервере, то CMS проверяет можно ли выполнить действие со всеми узлами указанного типа, запущенными на сервере. 
- Для низкоуровневых объектов CMS выполняет следующие проверки:

**Проверки для узла**
- Проверяется, есть ли блокировка на данном узле.
- Проверяется, можно ли взять блокировку на данный узел в соотвествии с тенантными и кластерными пределами недоступных узлов.
- Проверяется, можно ли взять блокировки на все VDisk-и данного узла.
- Проверяется, можно ли взять блокировку на кольцо State Storage данного узла в соотвествии с режимом доступности.
- Проверяется, можно ли взять блокировку на данный узел в соотвествии с пределом недоступных узлов, на которых могут запускаться системные таблетки определенного типа.

**Проверки для VDisk-а**
- Проверяется, есть ли блокировка на данном VDisk-е.
- Проверяется, есть ли блокировка на PDisk-е, которому принадлежит данный VDisk.
- Проверяется, есть ли блокировка на узле, которой принадлежит данный VDisk.
- Проверяется, можно ли взять блокировку на данный VDisk в соотвествии с режимом доступности.

**Проверки для PDisk-а**
- Проверяется, можно ли взять блокировку на все VDisk-и данного PDisk-а.

Если проверки прошли успешно, то на проверяемый низкоуровневый объект берется временная блокировка и CMS рассматривает следующие действие. Временные блокировки позволяют понять, конфликтуют ли запрошенные в одном запросе действия между собой. После завершения обработки запроса все временные блокировки снимаются.

## Примеры {#examples}

### Rolling restart кластера {#rolling-restart}

1) Подключитесь по SSH на один из серверов кластера.
    ```
    $ ssh {hostname}
    ```
2) Попросите разрешения у CMS на перезапуск этого сервера.
    ```
    $ ydbd cms request restart host {hostname} --user {name} --duration 5 --reason "Rolling restart"
    ``` 

    В случае если CMS выдал разрешение, то переходите к следующему шагу, иначе повторите попытку позже.

3) Перезапустите все необходимые узлы на этом сервере.
4) Повторите шаги 1—3 для оставших серверов в кластере.

### Перезапуск/остановка узла {#restart-or-stop-node}

1) Подключитесь по SSH на сервер, где запущен узел.
    ```
    $ ssh {hostname}
    ```
2) Попросите разрешения у CMS на перезапуск/остановку узла.
    ```
    $ ydbd cms request restart host {node_id} --user {name} --duration 5
    ``` 

    В случае если CMS выдал разрешение, то переходите к следующему шагу, иначе повторите попытку позже.

3) Перезапустите/остановите узел на этом сервере.
