# Обслуживание кластера без потери доступности

В промышленных инсталляциях кластер {{ ydb-short-name }} состоит из серверов с дисками. На сервере запускается один [статический узел](../cluster/topology.md), работающий с дисками, и несколько [динамических узлов](../cluster/topology.md).

Периодически кластер {{ ydb-short-name }} необходимо обслуживать, например, обновлять его версию или заменять сломавшиеся диски. Работы по обслуживанию могут привести к недоступности кластера или имеющихся баз данных из-за:
- Превышения модели отказа затронутых [групп хранения](../concepts/_includes/databases/storage_groups.md#storage-groups).
- Превышения модели отказа [State Storage](../deploy/configuration/config.md#domains-state).
- Недостатка вычислительных ресурсов вследствие остановки слишком большого количества динамических узлов.

Чтобы избежать этого, в {{ ydb-short-name }} есть встроенный компонент, который следит за состоянием кластера — *Cluster Management System (CMS)*. CMS реализован в виде системной [таблетки](../concepts/cluster/_includes/common_scheme_ydb/tablets.md#tablets), доступной через gRPC API. В CMS можно согласовать проведение работ. Для этого необходимо создать [задачу обслуживания](#maintenance-task) в CMS и указать в ней взятие эксклюзивных блокировок на компоненты кластера (например, узлы или сервера), которые будут задействованы в обслуживании. Компоненты, на которые взяты блокировки считаются недоступными с точки зрения CMS, и их можно безопасно обслуживать. CMS [проверит](#check-actionability-algorithm) текущее состояние кластера и возьмет блокировки, только если работы не приведут к потери доступности.

{% note warning "Поломки во время проведения согласованных работ" %}

Во время проведения работ, согласованных CMS, в кластере могут произойти поломки, из-за которых доступность кластера окажется под угрозой. Рекомендуется в срочном порядке завершить работы по обслуживанию, если это поможет снизить риск потери доступности.

{% endnote %}

## Задача обслуживания {#maintenance-task}

*Задача обслуживания* — представляет собой набор действий, которые пользователь просит выполнить CMS для возможности проведения безопасного обслуживания. Например, одним из действий является взятие эксклюзивной блокировки на компонент кластера — узел или сервер. 

В задаче действия делятся на группы. Действия из одной группы выполняются атомарно. На данный момент группы могут состоять только из одного действия.

Если в момент запроса действие выполнить нельзя, CMS сообщает причину и время, когда стоит обновить задачу, и переводит действие в статус *ожидания*. При обновлении задачи CMS повторно пытается выполнить ожидающие действия.

У *выполненных* действий есть дедлайн, после которого они считаются *завершенными* и прекращают иметь эффект на кластер. Например, снимается эксклюзивная блокировка. Пользователь может досрочно завершить действие.

{% note info "Затянувшиеся работы" %}

Если работы по обслуживанию кластера продолжают проводиться после завершения действий, то это расценивается как поломка в кластере.

{% endnote %}

Задачи по обслуживанию не удаляются автоматически. На данный момент завершенные действия автоматически удаляются из задачи.

### Режим доступности {#availability-mode}

В задаче обслуживания можно указать режим доступности кластера, который должен соблюдаться при проверке выполнимости действий. Поддерживаются следующие режимы:
- **Strong** — режим доступности, минимизирующий возможность поломки кластера.
    - Допускается не более одного недоступного [VDisk](../concepts/cluster/_includes/distributed_storage/distributed_storage_interface.md#storage-groups) в каждой из затрагиваемых групп хранения.
    - Допускается не более одного недоступного кольца State Storage.
- **Weak** — режим доступности, не позволяющий превысить модель отказа.
    - Допускается не более двух недоступных VDisk-ов для затрагиваемых групп хранения со схемой [block-4-2](../administration/production-storage-config.md#reliability).
    - Допускается не более четырех недоступных VDisk-ов, три из которых должны находиться в одном датацентре, для затрагиваемых групп хранения со схемой [mirror-3-dc](../administration/production-storage-config.md#reliability). 
    - Допускается не более `(nto_select - 1) / 2` недоступных колец State Storage.
- **Force** — принудительный режим доступности, модель отказа игнорируется.

По умолчанию используется **Strong**.

### Порядок выполнения действий при конфликтах {#order}

Задания, которые созданы в CMS раньше, имеют приоритет. Когда CMS рассматривает задачу, то состояние кластера рассматривается в худшем случае, как будто все ожидающие действия из задач, созданных в CMS раньше, выполнены. Таким образом действия задачи не могут быть выполнены, пока все конфликтующие действия из задач, созданных в CMS раньше, не будут завершены.

## Кластерные и тенантные лимиты недоступных узлов {#cluster-and-tenant-limits}

В конфигурации CMS можно настроить лимит количества недоступных узлов для базы данных (тенанта) или для кластера в целом. Поддерживаются относительные и абсолютные лимиты.

## Алгоритм проверки выполнимости действий {#check-actionability-algorithm}

CMS последовательно идет по каждой группе действий и проверяет действие внутри группы:
- Если объектом действия является сервер, то CMS проверяет можно ли выполнить действие со всеми узлами, запущенными на сервере. 
- Если объектом действий является узел, то CMS проверяет:
    - Есть ли блокировка на данном узле.
    - Можно ли взять блокировку на данный узел в соотвествии с тенантными и кластерными лимитами недоступных узлов.
    - Можно ли взять блокировки на все VDisk-и данного узла в соотвествии с режимом доступности.
    - Можно ли взять блокировку на кольцо State Storage данного узла в соотвествии с режимом доступности.
    - Можно ли взять блокировку на данный узел в соотвествии с лимитом недоступных узлов, на которых могут запускаться кластерные системные таблетки.
    
Если проверки прошли успешно, то действие можно выполнить и на проверенные узлы берется временная блокировка. После чего CMS рассматривает следующую группу действий. Временные блокировки позволяют понять, конфликтуют ли запрошенные в разных группах действия между собой. После полного завершения проверки временные блокировки снимаются.
